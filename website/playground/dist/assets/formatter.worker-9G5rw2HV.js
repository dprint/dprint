(function(){"use strict";const M=new TextDecoder,J=new TextEncoder;function k(){let e,t,n={},r="",i="",g="";return{setInstance(o){e=o},setHostFormatter(o){t=o},createImportObject(){let o=new Uint8Array(0),s=0;const u=l=>{o=new Uint8Array(l),s=0};return{dprint:{host_clear_bytes:l=>{u(l)},host_read_buffer:(l,a)=>{o.set(B(e,l,a),s),s+=a},host_write_buffer:(l,a,_)=>{B(e,l,_).set(o.slice(a,a+_))},host_take_file_path:()=>{r=M.decode(o),u(0)},host_take_override_config:()=>{n=JSON.parse(M.decode(o)),u(0)},host_format:()=>{const l=M.decode(o);try{return i=t?.({filePath:r,fileText:l,overrideConfig:n})??l,l===i?0:1}catch(a){return g=String(a),2}},host_get_formatted_text:()=>(o=J.encode(i),s=0,o.length),host_get_error_text:()=>(o=J.encode(g),s=0,o.length)}}}}}function O(e,t){t.setInstance(e);const n=e.exports,{get_plugin_schema_version:r,set_file_path:i,set_override_config:g,get_formatted_text:o,format:s,get_error_text:u,get_plugin_info:l,get_resolved_config:a,get_config_diagnostics:_,set_global_config:b,set_plugin_config:w,get_license_text:p,reset_config:S}=n,h=r(),v=3;if(h!==2&&h!==v)throw new Error(`Not compatible plugin. Expected schema ${v}, but plugin had ${h}.`);let y=!1;return{setConfig(c,d){P(c,d)},getConfigDiagnostics(){C();const c=_();return JSON.parse(T(e,c))},getResolvedConfig(){C();const c=a();return JSON.parse(T(e,c))},getFileMatchingInfo(){const c=l(),d=JSON.parse(T(e,c));return{fileExtensions:d.fileExtensions??[],fileNames:d.fileNames??[]}},getPluginInfo(){const c=l(),d=JSON.parse(T(e,c));return delete d.fileNames,delete d.fileExtensions,d},getLicenseText(){const c=p();return T(e,c)},formatText(c,d){if(c.bytesRange!=null)return c.fileText;if(t.setHostFormatter(d),C(),c.overrideConfig!=null){if(h===2)throw new Error("Cannot set the override configuration for this old plugin.");F(e,JSON.stringify(c.overrideConfig)),g()}F(e,c.filePath),i(),F(e,c.fileText);const x=s();switch(x){case 0:return c.fileText;case 1:return T(e,o());case 2:throw new Error(T(e,u()));default:throw new Error(`Unexpected response code: ${x}`)}}};function C(){y||P({},{})}function P(c,d){S?.(),F(e,JSON.stringify(c)),b(),F(e,JSON.stringify(d)),w(),y=!0}}function F(e,t){const n=e.exports,r=J.encode(t),i=r.length,g=n.get_wasm_memory_buffer_size(),o=I(e);n.clear_shared_bytes(i);let s=0;for(;s<i;){const u=Math.min(i-s,g);B(e,o,u).set(r.slice(s,s+u)),n.add_to_shared_bytes_from_buffer(u),s+=u}return i}function T(e,t){const n=e.exports,r=n.get_wasm_memory_buffer_size(),i=I(e),g=new Uint8Array(t);let o=0;for(;o<t;){const s=Math.min(t-o,r);n.set_buffer_with_shared_bytes(o,s);const u=B(e,i,s);g.set(u,o),o+=s}return M.decode(g)}function I(e){return e.exports.get_wasm_memory_buffer()}function B(e,t,n){return new Uint8Array(e.exports.memory.buffer,t,n)}const z=G(globalThis,{});function G(e,t){return new Proxy(e,{get(n,r,i){return r in t?t[r]:e[r]},set(n,r,i){return r in t&&delete t[r],e[r]=i,!0},deleteProperty(n,r){let i=!1;return r in t&&(delete t[r],i=!0),r in e&&(delete e[r],i=!0),i},ownKeys(n){const r=Reflect.ownKeys(e),i=Reflect.ownKeys(t),g=new Set(i);return[...r.filter(o=>!g.has(o)),...i]},defineProperty(n,r,i){return r in t&&delete t[r],Reflect.defineProperty(e,r,i),!0},getOwnPropertyDescriptor(n,r){return r in t?Reflect.getOwnPropertyDescriptor(t,r):Reflect.getOwnPropertyDescriptor(e,r)},has(n,r){return r in t||r in e}})}const V=new TextDecoder,R=new TextEncoder;function L(){function e(o){try{const s=z;s.Deno?s.Deno.stderr.writeSync(o):s.process&&s.process.stderr.writeSync(o)}catch{}}let t,n,r="",i="";return{setInstance(o){t=o},setHostFormatter(o){n=o},createImportObject(){let o=new Uint8Array(0);return{env:{fd_write:(s,u,l,a)=>{let _=0;const b=t.exports.memory.buffer,w=new DataView(b);for(let p=0;p<l;p++){const S=u+p*8,h=w.getUint32(S,!0),v=w.getUint32(S+4,!0),y=new Uint8Array(b,h,v);if(s===1||s===2)e(y);else return 1;_+=v}return w.setUint32(a,_,!0),0}},dprint:{host_has_cancelled:()=>0,host_write_buffer:s=>{U(t,s,o.length).set(o)},host_format:(s,u,l,a,_,b,w,p)=>{const S=g(s,u),h=g(_,b),v=h===""?{}:JSON.parse(h),y=g(w,p),C=l===0&&a===p?void 0:[l,a];try{return r=n?.({filePath:S,fileText:y,bytesRange:C,overrideConfig:v})??y,y===r?0:1}catch(P){return i=String(P),2}},host_get_formatted_text:()=>(o=R.encode(r),o.length),host_get_error_text:()=>(o=R.encode(i),o.length)}}}};function g(o,s){return V.decode(U(t,o,s))}}function Q(e,t){t.setInstance(e);const n=1,r=e.exports,{get_shared_bytes_ptr:i,set_file_path:g,set_override_config:o,clear_shared_bytes:s,get_formatted_text:u,format:l,format_range:a,get_error_text:_,get_plugin_info:b,get_config_file_matching:w,get_resolved_config:p,get_config_diagnostics:S,get_license_text:h,register_config:v,release_config:y}=r;let C=!1;return{setConfig(f,m){c(f,m)},getConfigDiagnostics(){P();const f=S(n);return JSON.parse(x(f))},getResolvedConfig(){P();const f=p(n);return JSON.parse(x(f))},getFileMatchingInfo(){const f=w(n);return JSON.parse(x(f))},getPluginInfo(){const f=b();return JSON.parse(x(f))},getLicenseText(){const f=h();return x(f)},formatText(f,m){if(f.bytesRange!=null&&a==null)return f.fileText;t.setHostFormatter(m),P(),f.overrideConfig!=null&&(d(JSON.stringify(f.overrideConfig)),o()),d(f.filePath),g(),d(f.fileText);const A=f.bytesRange!=null?a(n,f.bytesRange[0],f.bytesRange[1]):l(n);switch(A){case 0:return f.fileText;case 1:return x(u());case 2:throw new Error(x(_()));default:throw new Error(`Unexpected response code: ${A}`)}}};function P(){C||c({},{})}function c(f,m){y(n),d(JSON.stringify({global:f,plugin:m})),v(n),C=!0}function d(f){const m=R.encode(f),A=s(m.length);U(e,A,m.length).set(m)}function x(f){const m=i();return V.decode(U(e,m,f))}}function U(e,t,n){return new Uint8Array(e.exports.memory.buffer,t,n)}function X(e){const t=new WebAssembly.Module(e);return Y(t)}function Y(e){if(Z(e)===3){const n=k(),r=new WebAssembly.Instance(e,n.createImportObject());return O(r,n)}else{const n=L(),r=new WebAssembly.Instance(e,n.createImportObject());return Q(r,n)}}function Z(e){const t=j(e);if(t==null)throw new Error("Couldn't determine dprint plugin version. Maybe the js-formatter version is too old?");if(t===3||t===4)return t;throw t>4?new Error(`Unsupported new dprint plugin version '${t}'. Maybe the js-formatter version is too old?`):new Error(`Unsupported old dprint plugin version '${t}'. Please upgrade the plugin.`)}function j(e){function t(r){if(r==="get_plugin_schema_version")return 3;const i="dprint_plugin_version_";if(r.startsWith(i)){const g=parseInt(r.substring(i.length),10);if(!isNaN(g))return g}}const n=WebAssembly.Module.exports(e);for(const r of n){const i=t(r.name);if(i!=null)return i}}let E,$,N,D=new AbortController;onmessage=function(e){switch(e.data.type){case"LoadUrl":{q(e.data.url);break}case"SetConfig":{ee(e.data.config);break}case"Format":{re(e.data.filePath,e.data.fileText);break}}};function q(e){D.abort(),D=new AbortController;const t=D.signal;E=fetch(e,{signal:t}).then(n=>n.arrayBuffer()).then(n=>{const r=X(n);return ne(r),H(r,$??{}),N&&W(r,N.filePath,N.fileText),r}),E.catch(n=>{t.aborted||K(n)})}function ee(e){$=e,te()}function te(){E&&E.then(e=>{H(e,$??{}),N&&W(e,N.filePath,N.fileText)})}function re(e,t){N={filePath:e,fileText:t},E&&E.then(n=>W(n,e,t))}function H(e,t){oe(()=>e.setConfig({},t)),postMessage({type:"FileMatching",info:e.getFileMatchingInfo()})}function W(e,t,n){let r;try{r=e.formatText({filePath:t,fileText:n})}catch(i){r=i.message}postMessage({type:"Format",text:r})}function ne(e){postMessage({type:"PluginInfo",info:e.getPluginInfo()})}function oe(e){try{e()}catch(t){K(t)}}function K(e){postMessage({type:"Error",message:e.message})}})();
